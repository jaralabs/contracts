<div
  class="relative w-full bg-white rounded-lg shadow-sm overflow-hidden"
  [class.border]="bordered()"
  [class.border-gray-300]="bordered()"
>
  <!-- Loading State -->
  <div
    *ngIf="loading()"
    class="absolute inset-0 flex items-center justify-center bg-white/80 backdrop-blur-sm z-10"
  >
    <div
      class="w-10 h-10 border-4 border-orange-200 border-t-brand-orange rounded-full animate-spin"
    ></div>
  </div>

  <!-- Error State -->
  <div
    *ngIf="error() && !loading()"
    class="p-8 text-center rounded-lg border border-red-200 bg-red-50"
  >
    <div class="flex flex-col items-center justify-center">
      <div
        class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4"
      >
        <svg
          class="w-6 h-6 text-red-600"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
          />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-red-800 mb-2">
        Error al cargar los datos
      </h3>
      <p class="text-red-600 mb-4">
        {{ error()?.message || 'Error al cargar los datos' }}
      </p>
      <button
        (click)="handlePageChange(currentPage(), pageSize())"
        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm font-medium"
      >
        Reintentar
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div
    *ngIf="!loading() && !error() && paginatedData().length === 0"
    class="p-8 text-center rounded-lg border border-gray-200 bg-white"
  >
    <div
      class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <svg
        class="w-6 h-6 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
        ></path>
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 mb-2">
      No hay datos disponibles
    </h3>
    <p class="text-gray-600">No se encontraron registros para mostrar.</p>
  </div>

  <!-- Card View (Mobile/Tablet) -->
  <div
    *ngIf="
      shouldUseCardView() &&
      !loading() &&
      !error() &&
      paginatedData().length > 0
    "
    class="divide-y divide-gray-200 bg-white"
  >
    <div
      *ngFor="let record of paginatedData(); let i = index"
      [attr.data-row-key]="getRowKey(record, i)"
      (click)="handleRowClick(record, i)"
      class="p-5 cursor-pointer transition-all duration-200 hover:bg-gray-50 active:bg-gray-100"
    >
      <!-- Selection Checkbox -->
      <div
        *ngIf="rowSelectionValue()"
        class="flex items-center pb-3 mb-3 border-b border-gray-100"
      >
        <input
          type="checkbox"
          [checked]="isRowSelected(record, i)"
          (change)="toggleRowSelection(record, i)"
          (click)="$event.stopPropagation()"
          class="w-5 h-5 rounded border-gray-300 cursor-pointer checked:bg-brand-orange checked:border-brand-orange"
        />
      </div>

      <!-- Card Content -->
      <div class="space-y-3">
        <!-- ID - Grande y prominente -->
        <div>
          <span
            class="text-xs font-semibold text-gray-400 uppercase tracking-wider block mb-1"
          >
            {{ safeColumns()[0].title }}
          </span>
          <span
            class="text-lg font-bold text-brand-orange"
            [innerHTML]="renderCell(safeColumns()[0], record, i)"
          ></span>
        </div>

        <!-- Título/Descripción principal -->
        <div *ngIf="safeColumns().length > 1">
          <h3
            class="text-base font-bold text-gray-900 leading-snug"
            [innerHTML]="renderCell(safeColumns()[1], record, i)"
          ></h3>
        </div>

        <!-- Información en grid horizontal -->
        <div class="grid grid-cols-2 gap-4 pt-2">
          <div
            *ngFor="let column of safeColumns().slice(2)"
            class="flex flex-col space-y-1"
          >
            <span
              class="text-xs font-semibold text-gray-500 uppercase tracking-wide"
            >
              {{ column.title }}
            </span>
            <div
              class="text-sm font-bold text-gray-900"
              [innerHTML]="renderCell(column, record, i)"
            ></div>
          </div>
        </div>
      </div>

      <!-- Expand Button -->
      <div *ngIf="expandableValue()" class="pt-3 mt-3 border-t border-gray-100">
        <button
          (click)="toggleRowExpansion(record, i); $event.stopPropagation()"
          class="w-full py-2 flex items-center justify-center bg-gray-50 border border-gray-200 rounded-lg transition-colors hover:bg-gray-100 active:bg-gray-200"
        >
          <lucide-icon
            [img]="isRowExpanded(record, i) ? ChevronUp : ChevronDown"
            [size]="18"
            class="text-gray-600"
          ></lucide-icon>
        </button>
      </div>

      <!-- Expanded Content -->
      <div
        *ngIf="expandableValue() && isRowExpanded(record, i)"
        class="pt-3 mt-3 border-t border-gray-100 animate-fade-in"
      >
        <!-- Aquí se renderiza el contenido expandido -->
      </div>
    </div>
  </div>

  <!-- Table View (Desktop) -->
  <div
    *ngIf="
      !shouldUseCardView() &&
      !loading() &&
      !error() &&
      paginatedData().length > 0
    "
    class="overflow-x-auto"
  >
    <table
      class="w-full border-collapse"
      [class.text-sm]="sizeValue() === 'small'"
      [class.text-lg]="sizeValue() === 'large'"
    >
      <!-- Table Header -->
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <!-- Selection Column -->
          <th *ngIf="rowSelectionValue()" class="w-12 px-4 py-3 text-center">
            <input
              *ngIf="rowSelectionValue()?.type === 'checkbox'"
              type="checkbox"
              (change)="toggleAllSelection()"
              class="w-4 h-4 rounded border-gray-300 cursor-pointer checked:bg-brand-orange checked:border-brand-orange"
            />
          </th>

          <!-- Expand Column -->
          <th *ngIf="expandableValue()" class="w-12 px-4 py-3"></th>

          <!-- Data Columns -->
          <th
            *ngFor="let column of safeColumns()"
            [style.width]="column.width"
            [style.text-align]="column.align || 'left'"
            (click)="column.sorter && handleSort(column)"
            [class.cursor-pointer]="column.sorter"
            class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-nowrap select-none"
          >
            <div class="flex items-center gap-1">
              <span>{{ column.title }}</span>
              <span
                *ngIf="column.sorter"
                class="flex items-center text-gray-400"
              >
                <lucide-icon
                  *ngIf="getSortOrder(column) === null"
                  [img]="ArrowUpDown"
                  [size]="14"
                  class="text-gray-400"
                ></lucide-icon>
                <lucide-icon
                  *ngIf="getSortOrder(column) === 'ascend'"
                  [img]="ChevronUp"
                  [size]="14"
                  class="text-brand-orange"
                ></lucide-icon>
                <lucide-icon
                  *ngIf="getSortOrder(column) === 'descend'"
                  [img]="ChevronDown"
                  [size]="14"
                  class="text-brand-orange"
                ></lucide-icon>
              </span>
            </div>
          </th>
        </tr>
      </thead>

      <!-- Table Body -->
      <tbody class="bg-white">
        <ng-container *ngFor="let record of paginatedData(); let i = index">
          <tr
            [attr.data-row-key]="getRowKey(record, i)"
            (click)="handleRowClick(record, i)"
            class="border-b border-gray-100 cursor-pointer transition-colors hover:bg-gray-50 last:border-b-0"
          >
            <!-- Selection Cell -->
            <td *ngIf="rowSelectionValue()" class="px-4 py-4 text-center">
              <input
                type="checkbox"
                [checked]="isRowSelected(record, i)"
                (change)="toggleRowSelection(record, i)"
                (click)="$event.stopPropagation()"
                class="w-4 h-4 rounded border-gray-300 cursor-pointer checked:bg-brand-orange checked:border-brand-orange focus:ring-2 focus:ring-primary-400 focus:ring-offset-1"
              />
            </td>

            <!-- Expand Cell -->
            <td *ngIf="expandableValue()" class="px-4 py-4 text-center">
              <button
                (click)="
                  toggleRowExpansion(record, i); $event.stopPropagation()
                "
                class="p-1 transition-colors hover:text-brand-orange focus:outline-none"
              >
                <lucide-icon
                  [img]="isRowExpanded(record, i) ? ChevronDown : ChevronRight"
                  [size]="16"
                  class="text-gray-600"
                ></lucide-icon>
              </button>
            </td>

            <!-- Data Cells -->
            <td
              *ngFor="let column of safeColumns()"
              [style.text-align]="column.align || 'left'"
              class="px-4 py-4 text-sm text-gray-700"
            >
              <span [innerHTML]="renderCell(column, record, i)"></span>
            </td>
          </tr>

          <!-- Expanded Row -->
          <tr
            *ngIf="expandableValue() && isRowExpanded(record, i)"
            class="bg-gray-50"
          >
            <td
              [attr.colspan]="
                safeColumns().length +
                (rowSelectionValue() ? 1 : 0) +
                (expandableValue() ? 1 : 0)
              "
              class="px-4 py-4"
            >
              <div class="animate-fade-in">
                <!-- Aquí se renderiza el contenido expandido -->
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div
    *ngIf="paginationValue() && paginatedData().length > 0"
    class="border-t border-gray-200 bg-white"
  >
    <!-- Info de registros - Solo desktop -->
    <div class="hidden sm:flex items-center justify-between px-6 py-4">
      <div class="text-sm text-gray-600">
        Mostrando <strong>{{ (currentPage() - 1) * pageSize() + 1 }}</strong> a
        <strong>{{ Math.min(currentPage() * pageSize(), totalRows()) }}</strong>
        de
        <strong>{{ totalRows() }}</strong>
        registros
      </div>

      <div class="flex items-center gap-4">
        <div class="flex items-center gap-1">
          <!-- First Page Button -->
          <button
            [disabled]="currentPage() === 1"
            (click)="handlePageChange(1, pageSize())"
            class="w-9 h-9 flex items-center justify-center rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 active:bg-gray-200"
            title="Primera página"
          >
            <lucide-icon
              [img]="ChevronsLeft"
              [size]="16"
              class="text-gray-600"
            ></lucide-icon>
          </button>

          <!-- Previous Button -->
          <button
            [disabled]="currentPage() === 1"
            (click)="handlePageChange(currentPage() - 1, pageSize())"
            class="w-9 h-9 flex items-center justify-center rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 active:bg-gray-200"
            title="Página anterior"
          >
            <lucide-icon
              [img]="ChevronLeft"
              [size]="16"
              class="text-gray-600"
            ></lucide-icon>
          </button>

          <!-- Page Numbers -->
          <ng-container *ngFor="let page of getPageNumbers()">
            <button
              *ngIf="page !== -1"
              (click)="handlePageChange(page, pageSize())"
              [class.bg-brand-orange]="page === currentPage()"
              [class.text-white]="page === currentPage()"
              [class.hover:bg-orange-600]="page === currentPage()"
              [class.text-gray-700]="page !== currentPage()"
              [class.hover:bg-gray-100]="page !== currentPage()"
              [class.hover:text-gray-900]="page !== currentPage()"
              class="min-w-[2.25rem] h-9 px-2 flex items-center justify-center rounded text-sm font-medium transition-colors active:scale-95"
            >
              {{ page }}
            </button>
            <span
              *ngIf="page === -1"
              class="px-2 text-gray-400 select-none text-sm"
            >
              •••
            </span>
          </ng-container>

          <!-- Next Button -->
          <button
            [disabled]="currentPage() === getTotalPages()"
            (click)="handlePageChange(currentPage() + 1, pageSize())"
            class="w-9 h-9 flex items-center justify-center rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 active:bg-gray-200"
            title="Página siguiente"
          >
            <lucide-icon
              [img]="ChevronRight"
              [size]="16"
              class="text-gray-600"
            ></lucide-icon>
          </button>

          <!-- Last Page Button -->
          <button
            [disabled]="currentPage() === getTotalPages()"
            (click)="handlePageChange(getTotalPages(), pageSize())"
            class="w-9 h-9 flex items-center justify-center rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 active:bg-gray-200"
            title="Última página"
          >
            <lucide-icon
              [img]="ChevronsRight"
              [size]="16"
              class="text-gray-600"
            ></lucide-icon>
          </button>
        </div>

        <!-- Page Size Selector - Solo desktop -->
        <div
          *ngIf="showSizeChanger() && pageSizeOptions().length > 0"
          class="flex items-center gap-2 pl-4 border-l border-gray-300"
        >
          <span class="text-sm text-gray-600 whitespace-nowrap">Mostrar:</span>
          <select
            [value]="pageSize()"
            (change)="handlePageChange(1, +$any($event.target).value)"
            class="px-2 py-1 text-sm border border-gray-300 rounded cursor-pointer focus:outline-none focus:ring-2 focus:ring-primary-400 focus:border-primary-400"
          >
            <option *ngFor="let size of pageSizeOptions()" [value]="size">
              {{ size }}
            </option>
          </select>
          <span class="text-sm text-gray-600 whitespace-nowrap"
            >por página</span
          >
        </div>
      </div>
    </div>

    <!-- Paginación móvil - Mejorada -->
    <div class="sm:hidden flex flex-col">
      <!-- Info de registros -->
      <div
        class="px-4 py-3 text-center text-sm text-gray-600 border-b border-gray-200"
      >
        Mostrando <strong>{{ (currentPage() - 1) * pageSize() + 1 }}</strong> a
        <strong>{{ Math.min(currentPage() * pageSize(), totalRows()) }}</strong>
        de
        <strong>{{ totalRows() }}</strong>
      </div>

      <!-- Controles de navegación -->
      <div class="flex items-center justify-center gap-3 px-4 py-3">
        <!-- Selector de tamaño (sin etiquetas) -->
        <select
          *ngIf="showSizeChanger() && pageSizeOptions().length > 0"
          [value]="pageSize()"
          (change)="handlePageChange(1, +$any($event.target).value)"
          class="px-3 py-2 text-sm border border-gray-300 rounded-lg cursor-pointer focus:outline-none focus:ring-2 focus:ring-brand-orange focus:border-brand-orange bg-white font-medium text-gray-700"
        >
          <option *ngFor="let size of pageSizeOptions()" [value]="size">
            {{ size }}
          </option>
        </select>

        <!-- Navegación -->
        <div class="flex items-center gap-2">
          <button
            [disabled]="currentPage() === 1"
            (click)="handlePageChange(currentPage() - 1, pageSize())"
            class="w-10 h-10 flex items-center justify-center rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed bg-gray-100 active:bg-gray-200"
            title="Anterior"
          >
            <lucide-icon
              [img]="ChevronLeft"
              [size]="20"
              class="text-gray-700"
            ></lucide-icon>
          </button>

          <div class="flex items-center gap-1.5 mx-1">
            <span class="text-sm font-medium text-gray-700">{{
              currentPage()
            }}</span>
            <span class="text-sm text-gray-400">/</span>
            <span class="text-sm text-gray-500">{{ getTotalPages() }}</span>
          </div>

          <button
            [disabled]="currentPage() === getTotalPages()"
            (click)="handlePageChange(currentPage() + 1, pageSize())"
            class="w-10 h-10 flex items-center justify-center rounded-lg transition-colors disabled:opacity-30 disabled:cursor-not-allowed bg-gray-100 active:bg-gray-200"
            title="Siguiente"
          >
            <lucide-icon
              [img]="ChevronRight"
              [size]="20"
              class="text-gray-700"
            ></lucide-icon>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
