<div
  class="relative w-full bg-white rounded-lg shadow-sm overflow-hidden"
  [class.border]="bordered"
  [class.border-gray-300]="bordered"
>
  <!-- Loading State -->
  <div
    *ngIf="loading"
    class="absolute inset-0 flex items-center justify-center bg-white/80 backdrop-blur-sm z-10"
  >
    <div
      class="w-10 h-10 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"
    ></div>
  </div>

  <!-- Error State -->
  <div
    *ngIf="error && !loading"
    class="p-8 text-center rounded-lg border border-red-200 bg-red-50"
  >
    <div class="flex flex-col items-center justify-center">
      <div
        class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mb-4"
      >
        <svg
          class="w-6 h-6 text-red-600"
          fill="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"
          />
        </svg>
      </div>
      <h3 class="text-lg font-semibold text-red-800 mb-2">
        Error al cargar los datos
      </h3>
      <p class="text-red-600 mb-4">
        {{ error.message || 'Error al cargar los datos' }}
      </p>
      <button
        (click)="handlePageChange(currentPage(), pageSize())"
        class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors text-sm font-medium"
      >
        Reintentar
      </button>
    </div>
  </div>

  <!-- Empty State -->
  <div
    *ngIf="!loading && !error && paginatedData().length === 0"
    class="p-8 text-center rounded-lg border border-gray-200 bg-white"
  >
    <div
      class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"
    >
      <svg
        class="w-6 h-6 text-gray-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
        ></path>
      </svg>
    </div>
    <h3 class="text-lg font-semibold text-gray-800 mb-2">
      No hay datos disponibles
    </h3>
    <p class="text-gray-600">No se encontraron registros para mostrar.</p>
  </div>

  <!-- Card View (Mobile/Tablet) -->
  <div
    *ngIf="
      shouldUseCardView() && !loading && !error && paginatedData().length > 0
    "
    class="flex flex-col gap-4 p-4"
  >
    <div
      *ngFor="let record of paginatedData(); let i = index"
      [attr.data-row-key]="getRowKey(record, i)"
      (click)="handleRowClick(record, i)"
      class="bg-white border border-gray-200 rounded-lg p-4 cursor-pointer transition-all duration-200 hover:shadow-md hover:border-blue-200"
    >
      <!-- Selection Checkbox -->
      <div
        *ngIf="rowSelection"
        class="flex items-center pb-3 mb-3 border-b border-gray-100"
      >
        <input
          type="checkbox"
          [checked]="isRowSelected(record, i)"
          (change)="toggleRowSelection(record, i)"
          (click)="$event.stopPropagation()"
          class="w-4 h-4 rounded border-gray-300 cursor-pointer checked:bg-blue-600 checked:border-blue-600"
        />
      </div>

      <!-- Card Content -->
      <div class="flex flex-col gap-3">
        <div *ngFor="let column of safeColumns()" class="flex flex-col gap-1">
          <span
            class="text-xs font-semibold text-gray-500 uppercase tracking-wide"
            >{{ column.title }}:</span
          >
          <span
            class="text-sm text-gray-900 font-medium"
            [innerHTML]="renderCell(column, record, i)"
          ></span>
        </div>
      </div>

      <!-- Expand Button -->
      <div *ngIf="expandable" class="pt-3 mt-3 border-t border-gray-100">
        <button
          (click)="toggleRowExpansion(record, i); $event.stopPropagation()"
          class="w-full p-2 flex items-center justify-center bg-gray-50 border border-gray-200 rounded-md transition-colors hover:bg-gray-100"
        >
          <lucide-icon
            [img]="isRowExpanded(record, i) ? ChevronUp : ChevronDown"
            [size]="16"
            class="text-gray-600"
          ></lucide-icon>
        </button>
      </div>

      <!-- Expanded Content -->
      <div
        *ngIf="expandable && isRowExpanded(record, i)"
        class="pt-3 mt-3 border-t border-gray-100 animate-fade-in"
      >
        <!-- Aquí se renderiza el contenido expandido -->
      </div>
    </div>
  </div>

  <!-- Table View (Desktop) -->
  <div
    *ngIf="
      !shouldUseCardView() && !loading && !error && paginatedData().length > 0
    "
    class="overflow-x-auto"
  >
    <table
      class="w-full border-collapse"
      [class.text-sm]="size === 'small'"
      [class.text-lg]="size === 'large'"
    >
      <!-- Table Header -->
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <!-- Selection Column -->
          <th *ngIf="rowSelection" class="w-12 px-4 py-3 text-center">
            <input
              *ngIf="rowSelection.type === 'checkbox'"
              type="checkbox"
              (change)="toggleAllSelection()"
              class="w-4 h-4 rounded border-gray-300 cursor-pointer checked:bg-blue-600 checked:border-blue-600"
            />
          </th>

          <!-- Expand Column -->
          <th *ngIf="expandable" class="w-12 px-4 py-3"></th>

          <!-- Data Columns -->
          <th
            *ngFor="let column of safeColumns()"
            [style.width]="column.width"
            [style.text-align]="column.align || 'left'"
            (click)="column.sorter && handleSort(column)"
            [class.cursor-pointer]="column.sorter"
            class="px-4 py-3 text-xs font-semibold text-gray-500 uppercase tracking-wider whitespace-nowrap select-none"
          >
            <div class="flex items-center justify-between gap-2">
              <span>{{ column.title }}</span>
              <span
                *ngIf="column.sorter"
                class="flex items-center text-gray-400"
              >
                <lucide-icon
                  *ngIf="getSortOrder(column) === null"
                  [img]="ArrowUpDown"
                  [size]="16"
                  class="text-gray-400"
                ></lucide-icon>
                <lucide-icon
                  *ngIf="getSortOrder(column) === 'ascend'"
                  [img]="ChevronUp"
                  [size]="16"
                  class="text-blue-600"
                ></lucide-icon>
                <lucide-icon
                  *ngIf="getSortOrder(column) === 'descend'"
                  [img]="ChevronDown"
                  [size]="16"
                  class="text-blue-600"
                ></lucide-icon>
              </span>
            </div>
          </th>
        </tr>
      </thead>

      <!-- Table Body -->
      <tbody class="bg-white">
        <ng-container *ngFor="let record of paginatedData(); let i = index">
          <tr
            [attr.data-row-key]="getRowKey(record, i)"
            (click)="handleRowClick(record, i)"
            class="border-b border-gray-100 cursor-pointer transition-colors hover:bg-gray-50 last:border-b-0"
          >
            <!-- Selection Cell -->
            <td *ngIf="rowSelection" class="px-4 py-4 text-center">
              <input
                type="checkbox"
                [checked]="isRowSelected(record, i)"
                (change)="toggleRowSelection(record, i)"
                (click)="$event.stopPropagation()"
                class="w-4 h-4 rounded border-gray-300 cursor-pointer checked:bg-blue-600 checked:border-blue-600 focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
              />
            </td>

            <!-- Expand Cell -->
            <td *ngIf="expandable" class="px-4 py-4 text-center">
              <button
                (click)="
                  toggleRowExpansion(record, i); $event.stopPropagation()
                "
                class="p-1 transition-colors hover:text-blue-600 focus:outline-none"
              >
                <lucide-icon
                  [img]="isRowExpanded(record, i) ? ChevronDown : ChevronRight"
                  [size]="16"
                  class="text-gray-600"
                ></lucide-icon>
              </button>
            </td>

            <!-- Data Cells -->
            <td
              *ngFor="let column of safeColumns()"
              [style.text-align]="column.align || 'left'"
              class="px-4 py-4 text-sm text-gray-700"
            >
              <span [innerHTML]="renderCell(column, record, i)"></span>
            </td>
          </tr>

          <!-- Expanded Row -->
          <tr *ngIf="expandable && isRowExpanded(record, i)" class="bg-gray-50">
            <td
              [attr.colspan]="
                safeColumns().length +
                (rowSelection ? 1 : 0) +
                (expandable ? 1 : 0)
              "
              class="px-4 py-4"
            >
              <div class="animate-fade-in">
                <!-- Aquí se renderiza el contenido expandido -->
              </div>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div
    *ngIf="pagination && paginatedData().length > 0"
    class="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-white"
  >
    <div class="text-sm text-gray-600">
      Mostrando <strong>{{ (currentPage() - 1) * pageSize() + 1 }}</strong> a
      <strong>{{
        Math.min(
          currentPage() * pageSize(),
          pagination.totalRows || sortedData().length
        )
      }}</strong>
      de
      <strong>{{ pagination.totalRows || sortedData().length }}</strong>
      registros
    </div>

    <div class="flex items-center gap-4">
      <div class="flex items-center gap-1">
        <!-- First Page Button -->
        <button
          [disabled]="currentPage() === 1"
          (click)="handlePageChange(1, pageSize())"
          class="w-8 h-8 flex items-center justify-center rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
          title="Primera página"
        >
          <lucide-icon
            [img]="ChevronsLeft"
            [size]="16"
            class="text-gray-600"
          ></lucide-icon>
        </button>

        <!-- Previous Button -->
        <button
          [disabled]="currentPage() === 1"
          (click)="handlePageChange(currentPage() - 1, pageSize())"
          class="w-8 h-8 flex items-center justify-center rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
          title="Página anterior"
        >
          <lucide-icon
            [img]="ChevronLeft"
            [size]="16"
            class="text-gray-600"
          ></lucide-icon>
        </button>

        <!-- Page Numbers -->
        <ng-container *ngFor="let page of getPageNumbers()">
          <button
            *ngIf="page !== -1"
            (click)="handlePageChange(page, pageSize())"
            [class.bg-blue-600]="page === currentPage()"
            [class.text-white]="page === currentPage()"
            [class.hover:bg-blue-700]="page === currentPage()"
            [class.text-gray-700]="page !== currentPage()"
            [class.hover:bg-gray-100]="page !== currentPage()"
            [class.hover:text-gray-900]="page !== currentPage()"
            class="min-w-[2rem] h-8 px-2 flex items-center justify-center rounded text-sm font-medium transition-colors"
          >
            {{ page }}
          </button>
          <span *ngIf="page === -1" class="px-2 text-gray-400 select-none">
            •••
          </span>
        </ng-container>

        <!-- Next Button -->
        <button
          [disabled]="currentPage() === getTotalPages()"
          (click)="handlePageChange(currentPage() + 1, pageSize())"
          class="w-8 h-8 flex items-center justify-center rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
          title="Página siguiente"
        >
          <lucide-icon
            [img]="ChevronRight"
            [size]="16"
            class="text-gray-600"
          ></lucide-icon>
        </button>

        <!-- Last Page Button -->
        <button
          [disabled]="currentPage() === getTotalPages()"
          (click)="handlePageChange(getTotalPages(), pageSize())"
          class="w-8 h-8 flex items-center justify-center rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100"
          title="Última página"
        >
          <lucide-icon
            [img]="ChevronsRight"
            [size]="16"
            class="text-gray-600"
          ></lucide-icon>
        </button>
      </div>

      <!-- Page Size Selector -->
      <div
        *ngIf="pagination.showSizeChanger && pagination.pageSizeOptions"
        class="flex items-center gap-2 pl-4 border-l border-gray-300"
      >
        <span class="text-sm text-gray-600 whitespace-nowrap">Mostrar:</span>
        <select
          [value]="pageSize()"
          (change)="handlePageChange(1, +$any($event.target).value)"
          class="px-2 py-1 text-sm border border-gray-300 rounded cursor-pointer focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        >
          <option
            *ngFor="let size of pagination.pageSizeOptions"
            [value]="size"
          >
            {{ size }}
          </option>
        </select>
        <span class="text-sm text-gray-600 whitespace-nowrap">por página</span>
      </div>
    </div>
  </div>
</div>
